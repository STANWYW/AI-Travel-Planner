# 🎤 语音自动创建旅行计划功能

## ✅ 功能概述

现在您可以通过**一句话语音**自动创建完整的旅行计划，无需手动填写任何表单！

---

## 🎯 使用流程

### 1. 语音输入
访问创建计划页面，点击紫色卡片的 🎤 按钮，说出您的旅行计划。

**示例语音**:
- "我想去日本东京，5天，预算1万元，喜欢美食和动漫，带孩子"
- "去北京3天，预算5000块，2个人，喜欢历史"
- "上海7日游，1万5预算，3个人，购物和美食"

### 2. AI 自动解析
系统会自动：
- ✅ 识别语音内容
- ✅ 使用 AI 提取关键信息：
  - 目的地
  - 天数
  - 预算
  - 人数
  - 旅行偏好
  - 日期（如果未提及则自动推断）

### 3. 确认创建
解析成功后，弹出确认框显示提取的信息：
```
🎉 语音解析成功！

目的地：日本东京
天数：5 天
预算：¥10000
人数：2 人

是否直接创建计划并生成 AI 行程？
[直接创建] [填充表单]
```

**选项 1: 直接创建** ⭐ 推荐
- 自动创建旅行计划
- 自动生成 AI 详细行程
- 直接跳转到计划详情页
- **完全无需手动操作！**

**选项 2: 填充表单**
- 将信息填充到表单
- 您可以检查和修改
- 确认后手动提交

---

## 🏗️ 技术实现

### 后端流程

```
语音文本 → AI 解析服务 → 提取结构化数据 → 创建旅行计划 → 生成 AI 行程
```

**新增接口**:

1. **POST /api/voice/parse**
   - 解析语音文本为旅行计划数据
   - 使用用户选择的 AI 提供商（OpenRouter/DeepSeek）
   - 返回结构化数据

2. **POST /api/voice/create-plan**
   - 从语音文本直接创建旅行计划
   - 可选自动生成 AI 行程
   - 返回创建的计划

### 前端流程

```
语音识别 → 调用解析接口 → 显示确认框 → 用户选择 → 创建计划
```

---

## 📝 API 文档

### POST /api/voice/parse

**请求**:
```json
{
  "text": "我想去日本，5天，预算1万元"
}
```

**响应**:
```json
{
  "success": true,
  "planData": {
    "title": "日本5日游",
    "destination": "日本",
    "days": 5,
    "budget": 10000,
    "travelers": 1,
    "preferences": {
      "interests": ["美食", "动漫"],
      "pace": "轻松"
    },
    "startDate": "2025-11-16T00:00:00.000Z",
    "endDate": "2025-11-20T00:00:00.000Z"
  }
}
```

### POST /api/voice/create-plan

**请求**:
```json
{
  "text": "我想去日本，5天，预算1万元",
  "autoGenerate": true
}
```

**响应**:
```json
{
  "success": true,
  "message": "旅行计划创建成功",
  "travelPlan": {
    "id": "...",
    "title": "日本5日游",
    "destination": "日本",
    "itinerary": { ... },
    ...
  }
}
```

---

## 🎨 用户体验

### 语音输入示例

**完整信息**:
```
"我想去日本东京，5天，预算1万元，喜欢美食和动漫，带孩子"
```
→ AI 提取所有信息 ✅

**部分信息**:
```
"去北京3天，5000块"
```
→ AI 自动推断：
- 人数：1 人（默认）
- 日期：未来7天后开始
- 偏好：通用

**模糊信息**:
```
"想去上海玩几天"
```
→ AI 智能推断：
- 天数：3-5 天（根据常见情况）
- 预算：根据天数估算
- 日期：未来一周

---

## 🔧 AI 解析能力

### 支持提取的信息

| 信息 | 示例 | 是否必需 |
|------|------|---------|
| 目的地 | "日本"、"北京" | ✅ 必需 |
| 天数 | "5天"、"一周" | ⚠️ 可推断 |
| 预算 | "1万元"、"5000块" | ⚠️ 可推断 |
| 人数 | "2个人"、"带孩子" | ⚠️ 可推断 |
| 偏好 | "美食"、"历史" | ❌ 可选 |
| 日期 | "下个月"、"12月" | ⚠️ 可推断 |

### AI 智能推断

- **日期未提及**: 使用未来7天后的日期
- **天数未提及**: 根据目的地和预算推断（3-7天）
- **预算未提及**: 根据目的地和天数估算
- **人数未提及**: 默认1人
- **偏好未提及**: 空对象

---

## 🚀 快速测试

### 测试步骤

1. **访问创建计划页面**
   ```
   http://localhost/plans/create
   ```

2. **点击语音按钮**
   - 紫色卡片中的 🎤 按钮

3. **说出旅行计划**
   ```
   "我想去上海，3天，预算3000元，2个人，喜欢美食"
   ```

4. **等待解析**
   - 显示 "AI 正在解析语音内容..."
   - 等待 3-10 秒

5. **确认创建**
   - 查看解析结果
   - 点击 "直接创建"
   - 自动跳转到计划详情页

---

## 📊 功能完成度

| 功能 | 状态 | 说明 |
|------|------|------|
| 语音识别 | ✅ 100% | 科大讯飞 WebSocket |
| AI 解析 | ✅ 100% | OpenRouter/DeepSeek |
| 自动创建 | ✅ 100% | 一键创建计划 |
| 自动生成行程 | ✅ 100% | AI 生成详细行程 |
| 表单填充 | ✅ 100% | 可选填充表单 |
| 错误处理 | ✅ 100% | 完整错误提示 |

**总体完成度: 100%** ✅

---

## ⚠️ 注意事项

### 语音输入建议

1. **清晰表达**
   - 语速适中
   - 发音清晰
   - 环境安静

2. **包含关键信息**
   - 目的地（必需）
   - 天数或日期
   - 预算
   - 人数

3. **示例格式**
   ```
   "我想去[目的地]，[天数]天，预算[金额]元，[人数]个人，喜欢[偏好]"
   ```

### AI 解析限制

- 如果语音内容过于模糊，可能无法提取目的地
- 日期格式需要明确（"下个月"、"12月"等）
- 预算单位需要明确（"元"、"万"等）

---

## 🔍 调试指南

### 查看解析结果

**后端日志**:
```bash
docker-compose -f docker-compose.china.yml logs -f app | grep -E "解析|parse|语音"
```

**预期输出**:
```
开始解析语音文本: 我想去日本，5天，预算1万元
使用 DeepSeek 模型: deepseek-chat
解析成功
```

### 测试解析接口

```bash
curl -X POST http://localhost/api/voice/parse \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"text": "我想去北京，3天，预算5000元"}'
```

---

## 🎯 使用场景

### 场景 1: 快速创建
用户说一句话 → AI 解析 → 直接创建 → 完成 ✅

### 场景 2: 确认后创建
用户说一句话 → AI 解析 → 填充表单 → 用户确认 → 创建 ✅

### 场景 3: 修改后创建
用户说一句话 → AI 解析 → 填充表单 → 用户修改 → 创建 ✅

---

## 📝 示例对话

**用户**: "我想去日本，5天，预算1万元，喜欢美食和动漫，带孩子"

**系统**: 
1. 识别语音 ✅
2. AI 解析 ✅
3. 提取信息：
   - 目的地: 日本
   - 天数: 5
   - 预算: 10000
   - 人数: 2（带孩子）
   - 偏好: 美食、动漫
4. 显示确认框
5. 用户点击"直接创建"
6. 自动创建计划 ✅
7. 自动生成 AI 行程 ✅
8. 跳转到计划详情 ✅

**总耗时**: 约 15-30 秒（包括 AI 生成行程）

---

**实现时间**: 2025-11-09  
**版本**: v2.2.0  
**文档版本**: v1.0.0
